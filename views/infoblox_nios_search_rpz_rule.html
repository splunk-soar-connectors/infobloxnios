<!--
 Copyright 2025 Infoblox Inc.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
{% extends 'widgets/widget_template.html' %}
{% block custom_title_prop %}
  {% if title_logo %}
    style="background-size: auto 60%; background-position: 50%;
    background-repeat: no-repeat; background-image: url('/app_resource/{{ title_logo }}');"
  {% endif %}
{% endblock %}
{% block title1 %}{{ title1 }}{% endblock %}
{% block title2 %}{{ title2 }}{% endblock %}
{% block custom_tools %}{% endblock %}
{% block widget_content %}
  <!-- CSS for table formatting and modal -->
  <style>
    .widget-content .rpz-rule-view {
      overflow-y: auto;
      padding: 10px;
    }

    .rpz-rule-view .no-data {
      padding: 10px;
      border: 1px solid #ccc;
    }

    .rpz-rule-view .wf-table-horizontal {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      table-layout: fixed; /* Enable fixed table layout for better column control */
    }

    .rpz-rule-view .wf-table-horizontal th,
    .rpz-rule-view .wf-table-horizontal td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }

    /* Ref column specific styling */
    .rpz-rule-view .wf-table-horizontal th.ref-header,
    .rpz-rule-view .wf-table-horizontal td.ref-cell {
      width: 200px; /* Fixed width for ref column */
      max-width: 200px;
    }

    .rpz-rule-view .ref-content {
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
      white-space: normal;
      font-size: 11px; /* Smaller font for ref content */
      line-height: 1.3;
      max-height: 60px; /* Limit height */
      overflow: hidden;
      cursor: pointer;
      color: #337ab7;
      text-decoration: underline;
    }

    .rpz-rule-view .ref-content:hover {
      max-height: none; /* Show full content on hover */
    }

    .rpz-rule-view .data-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .rpz-rule-view .data-cell:hover {
      white-space: normal;
      word-break: break-all;
    }

    .rpz-rule-view .info-panel {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .rpz-rule-view .info-panel h4 {
      margin-top: 0;
    }

    .rpz-rule-view .boolean-value {
      font-weight: bold;
    }

    .rpz-rule-view .boolean-true {
      color: #3c763d;
    }

    .rpz-rule-view .boolean-false {
      color: #a94442;
    }

    .rpz-rule-view .empty-value {
      color: #777;
      font-style: italic;
    }

    .not-ref-cell{
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
      white-space: normal;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .modal-title {
      margin: 0;
      font-size: 1.2em;
    }

    .close-modal {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-modal:hover {
      color: black;
    }

    .json-content {
      white-space: pre-wrap;
      font-family: monospace;
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
  <div class="rpz-rule-view">
    {% if has_data %}
      <div class="info-panel">
        <h4>RPZ Rule Search Summary</h4>
        <table class="wf-table-horizontal">
          <tr>
            <td>
              <strong>Total Rules Found:</strong>
            </td>
            <td>{{ total_rules }}</td>
          </tr>
          {% if rule_name %}
            <tr>
              <td>
                <strong>Rule Name:</strong>
              </td>
              <td>{{ rule_name }}</td>
            </tr>
          {% endif %}
          <tr>
            <td>
              <strong>Object Type:</strong>
            </td>
            <td>{{ object_type }}</td>
          </tr>
          {% if output_fields %}
            <tr>
              <td>
                <strong>Output Fields:</strong>
              </td>
              <td>{{ output_fields }}</td>
            </tr>
          {% endif %}
        </table>
      </div>
      <h3>RPZ Rules</h3>
      <!-- Table with columns based on available fields -->
      <table class="wf-table-horizontal datatable">
        <thead>
          <tr>
            {% for field in display_fields %}
              {% if field == "ref" %}
                <th class="ref-header">{{ field|title }}</th>
              {% else %}
                <th>{{ field|title }}</th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for rule in results %}
            <tr>
              {% for field_info in rule %}
                {% if field_info.field_name == "ref" %}
                  <td class="ref-cell">
                    <span class="ref-content"
                          title="{{ field_info.display_value }}"
                          data-content="{{ field_info.display_value }}"
                          data-field="Reference">{{ field_info.display_value }}</span>
                  </td>
                {% else %}
                  <td class="not-ref-cell">
                    {% if field_info.field_type == "boolean" %}
                      {% if field_info.is_true %}
                        <span class="boolean-value boolean-true">True</span>
                      {% else %}
                        <span class="boolean-value boolean-false">False</span>
                      {% endif %}
                    {% elif field_info.field_type == "empty" %}
                      <span class="empty-value">{{ field_info.display_value }}</span>
                    {% elif field_info.field_type == "object" or field_info.field_type == "array" %}
                      <span class="object-value"
                            data-content="{{ field_info.json_value }}"
                            data-field="{{ field_info.field_name }}">{{ field_info.display_value }}</span>
                    {% else %}
                      {{ field_info.display_value }}
                    {% endif %}
                  </td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="no-data">
        <h3>No RPZ Rules Found</h3>
        <p>No RPZ rules were found matching the specified criteria. Try broadening your search parameters.</p>
      </div>
    {% endif %}
  </div>
  <!-- Modal for displaying complex objects -->
  <div id="dataModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Field Data</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="json-content"></div>
    </div>
  </div>
  <!-- Script to handle object expansion with modal -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get modal elements
      var modal = document.getElementById('dataModal');
      var modalTitle = modal.querySelector('.modal-title');
      var modalContent = modal.querySelector('.json-content');
      var closeBtn = modal.querySelector('.close-modal');

      // Add click handlers for object values and ref content
      var clickableElements = document.querySelectorAll('.object-value, .ref-content');
      clickableElements.forEach(function(element) {
        element.addEventListener('click', function() {
          var content = this.getAttribute('data-content');
          var field = this.getAttribute('data-field');

          if (this.classList.contains('ref-content')) {
            // For ref content, just display the full reference
            modalTitle.textContent = field;
            modalContent.textContent = content;
            modal.style.display = 'block';
          } else {
            // For object values, try to format as JSON
            try {
              var formattedJson = JSON.stringify(JSON.parse(content), null, 2);
              modalTitle.textContent = field + ' Data';
              modalContent.textContent = formattedJson;
              modal.style.display = 'block';
            } catch (e) {
              console.error('Error parsing JSON:', e);
              modalTitle.textContent = 'Error';
              modalContent.textContent = 'Could not parse data: ' + content;
              modal.style.display = 'block';
            }
          }
        });
      });

      // Close modal when clicking the close button
      closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });

      // Close modal when clicking outside the modal content
      window.addEventListener('click', function(event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      });
    });
  </script>
{% endblock %}
